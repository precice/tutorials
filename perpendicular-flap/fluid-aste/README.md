# Tutorial for replay mode

## Overview

This tutorial is an example how the Artificial Solver Testing Environment (aste) can be used. The idea is that you run a coupled simulation with two regular solvers and save the coupling data in every timestep. Then, this data is converted to aste-format. Finally, aste replaces one of the solvers and the simulation can be "replayed" using only one solver and aste with the previously computed results.

This tutorial uses the results from the [OpenFOAM-FEniCS perpendicular flap tutorial](https://github.com/precice/tutorials/tree/master/perpendicular-flap) as a basis. aste then replaces OpenFOAM.

## Requirements

To run this tutorial you need to install the following components:

- [preCICE](https://github.com/precice/precice/wiki/Get-preCICE)
- [aste](https://github.com/precice/aste/tree/develop)
- [FEniCS](https://fenicsproject.org/)
- [FEniCS-Adapter](https://github.com/precice/fenics-adapter)
- OpenFOAM, e.g. [OpenFOAM 7](https://openfoam.org/version/7/)
- [OpenFOAM Adapter](https://github.com/precice/openfoam-adapter/wiki/Building) matching the OpenFOAM version.

Make sure to add `aste/build` to the `PATH` such that the python scripts and `preciceMap` can be found from anywhere on your system.

## Step-by-Step explanations

### Generating vtk output during a simulation

The base case for this tutorial is the OpenFOAM-FEniCS perpendicular flap tutorial. So let's start in the the root-directory of that simulation [`tutorials/FSI/flap_perp/OpenFOAM-FEniCS`](https://github.com/precice/tutorials/tree/master/FSI/flap_perp/OpenFOAM-FEniCS).

To generate vtk output in preCICE, add the statement `<export:vtk directory="preCICE-output" />` to the `precice-config.xml` in `tutorials/perpendicular-flap` in the Solid participant. The result should look the following way:

```xml
<participant name="Solid">
    <use-mesh name="Solid-Mesh" provide="yes"/>
    <read-data name="Force" mesh="Solid-Mesh"/>
    <write-data name="Displacement" mesh="Solid-Mesh"/>
    <export:vtk directory="preCICE-output" />
</participant>
```

Then, run the simulation as explained in the [`README.md`](https://github.com/precice/tutorials/blob/develop/perpendicular-flap/README.md) of the case.

The exports can be found in the `preCICE-output` directory.

### Converting the output to aste format

Copy the `preCICE-output` folder to the root directory of the aste tutorial `tutorials/perpendicular-flap/fluid-aste`.
To convert the files to the correct format, open the `preCICE-output` folder and run

`precice_to_aste.py Solid-fenics -n 500 -t Forces0 --datadim 3`

### Replay of the simulation with aste

#### The quick way to run

1. Open two terminals and navigate to `solid-fenics` and `fluid-aste`.
1. Run `.../solid-fenics$ python3 solid.py` and `.../fluid-aste$ preciceMap -v -c ../precice-config-aste.xml -p Fluid --mesh preCICE-output/Solid-fenics` in two terminals.

Read on if you want to know what to change in the configuration files starting from the OpenFOAM-FEniCS tutorial.

#### The way to do it yourself

The aste-FEniCS tutorial provides its own `precice-config.xml` and `precice-adapter-config-fsi-s.json` for getting started quickly. They are called `precice-config-aste.xml` and `precice-adapter-config-fsi-s-aste.json`.

However, these can also be generated by modifiying the files from the original `perpendicular-flap` case. The main purpose of this tutorial is to explain how the replay mode with aste can be used for arbirtrary simulation setups.

1. Copy the files `perpendicular-flap/precice-config.xml` and `perpendicular-flap/solid-fenics/precice-adapter-config-fsi-s.json` from the original `perpendicular-flap` tutorial into the respective directories.
2. Remove the line `"write_data_name": "Displacement"` from `precice-adapter-config-fsi-s.json`, because we will not write any data to aste.
3. Change the `read_data_name` from `Force` to `Data` since aste works with the general data name `Data`.
4. In ```precice-config.xml``` we require some more changes:
    1. Rename `Force` to `Data` throughout the whole file.
    2. Delete all lines where `Displacement` occurs, since we are only coupling in one direction (from aste to FEniCS).
5. Then we process the Fluid meshes to fake the Fluid participant using aste:
    1. Rename `Fluid-Mesh` to `MeshA` throughout the whole file.
    2. Delete the `mesh` `"Fluid-Mesh-Nodes"` and all lines where `"Fluid-Mesh-Nodes"` occurs.
    3. Rename the participant `Fluid` to `A`
6. Change the coupling scheme to an explicit scheme:
    1. Change `serial-implicit` to `serial-explicit`.
    2. Explicit schemes don't iterate such that they don't need convergence measures, extrapolation or acceleration. Delete everything in the coulping scheme except for
    
    ```xml
      <participants first="A" second="Solid" />
      <max-time value="5.0" />
      <time-window-size value="1.e-2" />
      <exchange data="Data" mesh="Solid-Mesh" from="A" to="Solid" />
    ```

#### Run

After applying these preparations, we are now able to run the tutorial in two terminals as described above.

### Play Around

If you want to explore more possibilities of the Replay-Mode here are some ideas:

- Export the output at the Fluid participant. Instead of `preCICE-output/Solid-fenics.*` the files containing the forces will be `preCICE-output/Fluid-Mesh-Faces-Fluid.*`

- Export the forces in the [Calculix-Openfoam-tutorial](https://github.com/precice/tutorials/tree/master/perpendicular-flap) with the same geometry and feed them to FEniCS with aste. 

- If you are familiar with the OpenFOAM-Adapter you can also replace FEniCS with aste such that aste writes previously exported displacements to OpenFOAM.

