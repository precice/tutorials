## Overview

This tutorial is an example how the Artificial Solver Testing Environment (aste) can be used. The idea is that you run a coupled simulation with two regular solvers and save the coupling data in every timestep. Then, this data is converted to aste-format. Finally, aste replaces one of the solvers and the simulation can be "replayed" using only one solver and aste with the previously computed results.

This tutorial uses the results from the [OpenFOAM-FEniCS perpendicular flap tutorial](https://github.com/precice/tutorials/tree/master/FSI/flap_perp/OpenFOAM-FEniCS) as a basis. aste then replaces OpenFOAM.

## Requirements

To run this tutorial you need to install the following components:
- [preCICE](https://github.com/precice/precice/wiki/Get-preCICE)
- [aste](https://github.com/precice/aste/tree/develop)
- [FEniCS](https://fenicsproject.org/)
- [FEniCS-Adapter](https://github.com/precice/fenics-adapter)
- OpenFOAM, e.g. [OpenFOAM 7](https://openfoam.org/version/7/)
- [OpenFOAM Adapter](https://github.com/precice/openfoam-adapter/wiki/Building) matching the OpenFOAM version.

Make sure to add `aste/build` to the `PATH` such that the python scripts and `preciceMap` can be found from anywhere on your system.

## Step-by-Step explanations

### Generating vtk output during a simulation

The base case for this tutorial is the OpenFOAM-FEniCS perpendicular flap tutorial. So let's start in the the root-directory of that simulation [`tutorials/FSI/flap_perp/OpenFOAM-FEniCS`](https://github.com/precice/tutorials/tree/master/FSI/flap_perp/OpenFOAM-FEniCS).

To generate vtk output in preCICE, add the statement `<export:vtk directory="preCICE-output" />` to the `precice-config.xml` in `tutorials/FSI/flap_perp/OpenFOAM-FEniCS` in the Solid participant. The result should look the following way:
```
<participant name="fenics">
    <use-mesh name="Solid" provide="yes"/>
    <read-data name="Forces0" mesh="Solid"/>
    <write-data name="Displacements0" mesh="Solid"/>
    <export:vtk directory="preCICE-output" />
</participant>
```
Then, run the simulation as explained in the [`README.md`](https://github.com/precice/tutorials/blob/develop/FSI/flap_perp/OpenFOAM-FEniCS/README.md) of the case.

The exports can be found in the `preCICE-output` directory.

### Converting the output to aste format.

Copy the `preCICE-output` folder to the root directory of the aste tutorial `tutorials/FSI/flap_perp/ASTE`.
To convert the files to the correct format, open the `preCICE-output` folder and run

`precice_to_aste.py Solid-fenics -n 500 -t Forces0 --datadim 3`

### Replay of the simulation with aste

#### The quick way to run 

1. Copy `perp_flap.py` from `tutorials/FSI/flap_perp/OpenFOAM-FEniCS/Solid` into `tutorials/FSI/flap_perp/ASTE/Solid`.

2. Run `python3 Solid/perp-flap.py` and `preciceMap -v -c precice-config.xml -p A --mesh preCICE-output/Solid-fenics` in two terminals.

Read on if you want to know what to change in the configuration files starting from the OpenFOAM-FEniCS tutorial.

#### The way to do it yourself

The aste-FEniCS tutorial provides its own `precice-config.xml` and `precice-adapter-config-fsi-s.json` for getting started quickly.

However, these can also be generated by modifiying the files from the OpenFOAM-FEniCS case. The main purpose of this tutorial is to explain how the replay mode with aste can be used for arbirtrary simulation setups.

1. Copy the files from the OpenFOAM-FEniCS tutorial into the respective directory of the aste-tutorial. 
2. Remove the line `"write_data_name": "Displacements0" ` from `precice-adapter-config-fsi-s.json`, because we don't write data to aste.
3. Change the `read_data_name` from `Forces0` to `Data` since aste works with the general data name `Data`.
4. In ```precice-config.xml``` we require some more changes:
    1. Rename `Forces0` to `Data` throughout the whole file.
    2. Delete all lines where `Displacements0` occurs, since we are only coupling in one direction (from aste to FEniCS).
5. Then we process the Fluid meshes to fake the Fluid participant using aste:
    1. Rename `Fluid-Mesh-Faces` to `MeshA` throughout the whole file.
    2. Delete the `mesh` `"Fluid-Mesh-Nodes"` and all lines where `"Fluid-Mesh-Nodes"` occurs.
    3. Rename the participant `Fluid` to `A`
6. Change the coupling scheme to an explicit scheme:
    1. Change `serial-implicit` to `serial-explicit`.
    2. Explicit schemes don't iterate such that they don't need convergence measures, extrapolation or acceleration. Delete everything in the coulping scheme except for 
    ```
      <participants first="A" second="fenics" />
      <max-time value="5.0" />
      <time-window-size value="1.e-2" />
      <exchange data="Data" mesh="Solid" from="A" to="fenics" />
    ```

#### Run

After applying these preparations, we are now able to run the tutorial in two terminals with `python3 Solid/perp-flap.py` and `preciceMap -v -c precice-config.xml -p A --mesh preCICE-output/Solid-fenics`.

### Play Around

If you want to explore more possibilities of the Replay-Mode here are some ideas:

- Export the output at the Fluid participant. Instead of `preCICE-output/Solid-fenics.*` the files containing the forces will be `preCICE-output/Fluid-Mesh-Faces-Fluid.*`

- Export the forces in the [Calculix-Openfoam-tutorial](https://github.com/precice/tutorials/tree/master/FSI/flap_perp/OpenFOAM-CalculiX) with the same geometry and feed them to FEniCS with aste. 

- If you are familiar with the OpenFOAM-Adapter you can also substitute FEniCS with aste such that aste writes previously exported displacements to OpenFOAM.

