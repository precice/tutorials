## Overview

This tutorial is an example how the Artificial Solver Testing Environment (aste) can be used. The idea is that you run a coupled simulation with two regular solvers and save the coupling data in every timestep. Then, this data is converted to aste-format. Finally, aste substitutes one of the solvers and the simulation can be "replayed" using only one solver and aste with the previously computed results.


The base simulation for this tutorial is the OpenFOAM-FEniCS perpendicular flap tutorial. aste then substitutes OpenFOAM.

## Requirements

To run this tutorial you need to install the following components:
- [preCICE](https://github.com/precice/precice/wiki/Get-preCICE)
- [aste](https://github.com/precice/aste/tree/develop)
- [FEniCS](https://fenicsproject.org/)
- [FEniCS-Adapter](https://github.com/precice/fenics-adapter)
- OpenFOAM, e.g. [OpenFOAM 7](https://openfoam.org/version/7/)
- [OpenFOAM Adapter](https://github.com/precice/openfoam-adapter/wiki/Building) matching the OpenFOAM version.

Make sure to add aste/build to the ```PATH``` such that the python scripts and ```preciceMap``` can be found from anywhere on your system.

## Step-by-Step explanations

### Generating vtk output during a simulation

The base case for this tutorial is the OpenFOAM-FEniCS perpendicular flap tutorial. So let's start in the the root-directory of that simulation.
To generate a vtk output in preCICE, add the following line to ```precice-config.xml``` after [line 41](https://github.com/precice/tutorials/blob/develop/FSI/flap_perp/OpenFOAM-FEniCS/precice-config.xml#L41) in the Solid participant:
```<export:vtk directory="preCICE-output" />```

Then, the simulation can be run in two terminals with ```bash ./runFluid``` and ```python3 Solid/perp_flap.py```.
The exports are in the ```preCICE-output``` directory.

### Converting the output to aste format.

Copy the ```preCICE-output``` folder to the root directory of the aste tutorial. 
To convert the files to the correct format, open the ```preCICE-output``` folder and run

```precice_to_aste.py -n 500 -f Forces0 --datadim 3```

### Replay of the simulation with aste

#### The quick way to run 
Copy perp_flap.py from OpenFOAM-FEniCS/Solid to aste/Solid

run in two terminals ```python3 Solid/perp-flap.py``` and ```preciceMap -v -c precice-config.xml -p A --mesh preCICE-output/Solid-fenics --vectordata```

Read on if you want to know what to change in the configuration files starting from the OpenFOAM-FEniCS tutorial.

#### The way to do it yourself

The aste-FEniCS simulation has its own ```precice-config.xml``` and ```precice-adapter-config-fsi-s.json```. 
However, these can be generated by modifiying the files from the OpenFOAM-FEniCS case. 

First, copy the files from the OpenFOAM-FEniCS tutorial into the respective directory of the aste-tutorial. 

For ```precice-adapter-config-fsi-s.json``` we remove the line ```"write_data_name": "Displacements0",``` because we don't write data to aste.
Plus, we change to the ```read_data_name``` from ```Forces0``` to ```Data``` since aste works with the general data name ```Data```.

In ```precice-config.xml``` we need more changes:

- Again, we rename ```Forces0``` to ```Data``` throughout the whole file.
- We delete all lines where ```Displacements0``` occurs, since we are only coupling in the other direction.


Then, you substitute the Fluid meshes and the Fluid participant with aste:

- Rename ```Fluid-Mesh-Faces``` to ```MeshA``` throughout the whole file.
- Delete the ```mesh``` ```"Fluid-Mesh-Nodes"``` and all lines where ```"Fluid-Mesh-Nodes"``` occurs.
- Rename the participant ```Fluid``` to ```A```

Last, you need to change the coupling scheme to an explicit scheme:

- Change ```serial-implicit``` to ```serial-explicit```.
- Explicit schemes don't iterate such that they don't need convergence measures, extrapolation or acceleration. Delete everything in the coulping scheme except for 
```
      <participants first="A" second="fenics" />
      <max-time value="5.0" />
      <time-window-size value="1.e-2" />
      <exchange data="Data" mesh="Solid" from="A" to="fenics" />
```

### Run

Finally, run the tutorial in two shells with ```python3 Solid/perp-flap.py``` and ```preciceMap -v -c precice-config.xml -p A --mesh preCICE-output/Solid-fenics --vectordata```.

### Play Around

If you want to explore more possibilities of the Replay-Mode here are some ideas:

- Export the output at the Fluid participant. Instead of ```preCICE-output/Solid-fenics.*``` the files containing the forces will be ```preCICE-output/Fluid-Mesh-Faces-Fluid.*```

- Export the forces in the [Calculix-Openfoam-tutorial](https://github.com/precice/tutorials/tree/master/FSI/flap_perp/OpenFOAM-CalculiX) with the same geometry and feed them to FEniCS with aste. 

- If you are familiar with the OpenFOAM-Adapter you can also substitute FEniCS with aste such that aste writes previously exported displacements to OpenFOAM.



